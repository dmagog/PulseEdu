name: Release Quality Check

on:
  push:
    tags:
      - 'v*.*.*'  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞ»Ğ¸Ğ·Ğ¾Ğ²
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to check (e.g., v0.2.0)'
        required: true
        type: string

jobs:
  release-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Black (code formatting)
      run: |
        echo "ğŸ¨ Checking code formatting with Black..."
        black --check --diff app/ tests/
        echo "âœ… Code formatting is correct"
    
    - name: Run isort (import sorting)
      run: |
        echo "ğŸ“¦ Checking import sorting with isort..."
        isort --check-only --diff app/ tests/
        echo "âœ… Import sorting is correct"
    
    - name: Run Flake8 (linting)
      run: |
        echo "ğŸ” Running linting with Flake8..."
        flake8 app/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "âœ… Linting completed"
    
    - name: Run MyPy (type checking)
      run: |
        echo "ğŸ”¬ Running type checking with MyPy..."
        mypy app/ --ignore-missing-imports --no-strict-optional
        echo "âœ… Type checking completed"
    
    - name: Run Bandit (security check)
      run: |
        echo "ğŸ”’ Running security check with Bandit..."
        bandit -r app/ -ll
        echo "âœ… Security check completed"
    
    - name: Run full test suite
      run: |
        echo "ğŸ§ª Running full test suite..."
        python -m pytest tests/ --cov=app --cov-report=term-missing -v
        echo "âœ… All tests passed"
    
    - name: Release Quality Summary
      run: |
        echo "ğŸ‰ Release Quality Check Completed Successfully!"
        echo ""
        echo "ğŸ“Š Quality Metrics:"
        echo "  - Code formatting: âœ… Black"
        echo "  - Import sorting: âœ… isort"
        echo "  - Linting: âœ… Flake8"
        echo "  - Type checking: âœ… MyPy"
        echo "  - Security: âœ… Bandit"
        echo "  - Testing: âœ… pytest"
        echo ""
        echo "ğŸ·ï¸ Release: ${{ github.ref_name || inputs.version }}"
        echo "ğŸ“¦ Repository: ${{ github.repository }}"
        echo "âœ… Ready for production deployment!"
