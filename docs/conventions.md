# Пульс.EDU — CONVENTIONS (правила для code‑ассистента)

> KISS. Это краткий свод правил, которые **обязательны** при автогенерации и ручной доработке кода. Полные решения и границы — в `@vision.md`. Здесь не дублируем описание, а фиксируем только то, что влияет на качество и единообразие.

---

## 1) Общие принципы
- **KISS**: минимально достаточные решения. Не добавляй библиотек вне перечисленных в `@vision.md`.
- **Единый источник истины**: если что‑то не описано здесь — смотри соответствующий раздел `@vision.md` и следуй ему.
- **Ясность > гибкость**: меньше абстракций, короче файлы/функции, явные зависимости.
- **Никаких «магических» оптимизаций** в MVP (кеши, фоновые воркары, флаги) — только те, что зафиксированы в `@vision.md`.

## 2) Стек и зависимости
- Используй **только** стек из `@vision.md` (FastAPI, SQLModel+Alembic, Jinja2+Bootstrap, Celery+RabbitMQ, pandas+openpyxl, logging, Chart.js CDN, SMTP/MailHog).
- Запрещено подтягивать фронтовые сборщики, SPA‑фреймворки, ORM‑замены, DI‑контейнеры и т.п.

## 3) Структура проекта и наименование
- Файлы и каталоги совпадают со структурой из `@vision.md` (`app/models|routes|services|database|ui`, `worker/*`, `migrations/*`).
- **models**: один модуль — один домен (например, `assessment.py`).
- **routes**: один файл — один роутер (ресурс). Имена маршрутов — kebab‑case, префиксы по роли/ресурсу (например, `/student/events`).
- **services**: бизнес‑логика; **services/crud** — тонкие CRUD без побочных эффектов.
- **database**: `engine.py`, `session.py`, никаких глобальных синглтонов.
- Имена очередей Celery строго: `auth`, `ingest`, `email`, `llm`, `cluster`.

## 4) API и обработка ошибок
- Роутеры возвращают **HTML** (Jinja) для страниц и **JSON** для API (если явно указано). Не смешивай.
- Схемы ввода/вывода — через Pydantic models (минимально).
- Единый обработчик ошибок FastAPI; текст ошибок — короткий, без стека пользователю.
- RBAC навешивается декораторами/Depends (см. `rbac.py`). Доступ проверяем **на входе** в роутер.

## 5) База и миграции
- Модели — **SQLModel**. Обязательные поля без `nullable=True` по умолчанию.
- Внешние ключи и индексы — явные. Enum‑ы — через `Enum`/`Literal`.
- Миграции — только через **Alembic**; один PR — одна миграция.

## 6) Импорт Excel (ingest)
- Формат — **схематичный**. Маппинг колонок — из YAML (`EXCEL_MAPPING_FILE`), регистр/пробелы игнорировать.
- Все загрузки идут через **ImportJob**: статусы, ошибки — в `errors_json`.
- Частичные загрузки не используем; при ошибке — откат всего job (MVP).

## 7) Очереди и фоновые задачи
- Долгие операции **запрещены** в web‑процессе — только через Celery (`ingest`, `email`, `llm`, `cluster`, `beat`).
- Каждая задача **идемпотентна** и логирует `job_id`, `queue`, `task_name`.
- Ретраи и таймауты — только те, что зафиксированы в `@vision.md`.

## 8) LLM (рекомендации)
- Используй `services/llm_provider.py` (коннектор Yandex.Cloud).
- Параметры (таймауты, лимиты, язык, TTL кеша) берем из **админ‑настроек**; не хардкодить.
- Кеш ключ: `(student_id, course_id, data_version)`.
- Храним **response_json** (короткие тексты рекомендаций). Текст может содержать Markdown; при выводе используем безопасный рендер `render_markdown_safe()`. Не передаём ПДн в запрос.
- При недоступности — warning в UI + ретрай в очереди `llm`. Без правиловых рекомендаций в MVP.

## 9) Уведомления (email)
- Отправка — только через `services/email_service.py`. Шаблоны — в `notify/templates/`.
- Никаких сторонних email‑SDK. В dev — MailHog.

## 10) Логгирование и аудит
- Только стандартный **logging**, вывод в STDOUT, формат `key=value` (timestamp, level, logger, request_id, msg).
- Используй доменные логгеры: `app.import`, `app.recommend`, `app.notify`, `app.auth`, `app.cluster`, `app.llm`.
- Генерируй `request_id` (middleware) и прокидывай в логи задач.
- Веди таблицы: `ImportJob` (журнал загрузок), `user_auth_log`, `llm_call_log` (retention управляется в админке).

## 11) Конфигурация
- Секреты — **только** из ENV/Secrets, никогда не коммитим.
- Динамические параметры (LLM, мониторинг, retention и т.п.) читаем из админ‑настроек (БД); поддерживай «горячее» чтение.

## 12) Тесты (минимум)
- Pytest дымовые: `/healthz`, happy‑path импорта и пересчёта, отправка письма.
- Без цели по % покрытия, только критические пути.

## 13) UI и дашборды
- Jinja2 + **Bootstrap**; без SPA и сборки. Мини‑графики — **Chart.js** через CDN.
- Разрешён базовый **Markdown** от LLM (жирный, курсив, списки). Перед показом **конвертировать Markdown→HTML и санитизировать** (разрешены теги: `p`, `br`, `strong`, `em`, `ul`, `ol`, `li`; ссылки/изображения/код — запрещены). В шаблоне Jinja2 использовать только после санитизации (`|safe`).

## 14) Коммиты и релизы
- SemVer‑теги `v0.x.y`. Короткие PR; формат коммитов свободный, но осмысленный (present tense).
- `CHANGELOG.md` обновлять при пользовательских изменениях.

---

**Приоритет источников**: если в этих правилах что‑то не описано или есть спор — смотри соответствующий раздел `@vision.md` и действуй по нему. Все отступления — только через владельца проекта.

