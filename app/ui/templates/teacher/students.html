{% extends "base.html" %}

{% block title %}{{ title }} - PulseEdu{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-people"></i> Мои студенты</h1>
            <p class="text-muted">Управление студентами и мониторинг их прогресса</p>
        </div>
    </div>

    <!-- Внутренняя навигация -->
    {% include "teacher/_navigation.html" %}

    <!-- Student Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <select class="form-select" id="courseFilter">
                                <option value="">Все курсы</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="groupFilter">
                                <option value="">Все группы</option>
                                <option value="A">Группа A (Отличники)</option>
                                <option value="B">Группа B (Хорошисты)</option>
                                <option value="C">Группа C (Требуют внимания)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">Все статусы</option>
                                <option value="active">Активные</option>
                                <option value="at_risk">В зоне риска</option>
                                <option value="excellent">Отличники</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="Поиск по имени или ID...">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-funnel"></i> Применить фильтры
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportStudents()">
                                <i class="bi bi-download"></i> Экспорт
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-table"></i> Список студентов</h5>
                    <span class="badge bg-primary">{{ students|length }} студентов</span>
                </div>
                <div class="card-body">
                    {% if students %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Имя</th>
                                        <th>Курсы</th>
                                        <th>Группа</th>
                                        <th>Прогресс</th>
                                        <th>Посещаемость</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                    <tr class="student-row" 
                                        data-course="{{ student.course_ids|join(',') }}" 
                                        data-group="{{ student.cluster_group }}"
                                        data-status="{{ student.status }}"
                                        data-name="{{ student.name|lower }}"
                                        data-id="{{ student.id|lower }}">
                                        <td>
                                            <strong>{{ student.id }}</strong>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar me-2">
                                                    <i class="bi bi-person-circle text-primary" style="font-size: 1.5rem;"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ student.name }}</div>
                                                    <small class="text-muted">{{ student.email }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% for course in student.courses %}
                                                <span class="badge bg-light text-dark me-1">{{ course.name }}</span>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% if student.cluster_group == 'A' %}
                                                <span class="badge bg-success">A (Отличники)</span>
                                            {% elif student.cluster_group == 'B' %}
                                                <span class="badge bg-warning">B (Хорошисты)</span>
                                            {% elif student.cluster_group == 'C' %}
                                                <span class="badge bg-danger">C (Риск)</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Не определено</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" style="width: {{ student.overall_progress }}%">
                                                    {{ student.overall_progress }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="me-2">{{ student.attendance_rate }}%</span>
                                                {% if student.attendance_rate >= 80 %}
                                                    <i class="bi bi-check-circle text-success"></i>
                                                {% elif student.attendance_rate >= 60 %}
                                                    <i class="bi bi-exclamation-triangle text-warning"></i>
                                                {% else %}
                                                    <i class="bi bi-x-circle text-danger"></i>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if student.status == 'excellent' %}
                                                <span class="badge bg-success">Отличник</span>
                                            {% elif student.status == 'at_risk' %}
                                                <span class="badge bg-danger">В зоне риска</span>
                                            {% else %}
                                                <span class="badge bg-primary">Активный</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-outline-primary btn-sm" onclick="viewStudent('{{ student.id }}')">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-info btn-sm" onclick="viewProgress('{{ student.id }}')">
                                                    <i class="bi bi-graph-up"></i>
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm" onclick="sendMessage('{{ student.id }}')">
                                                    <i class="bi bi-chat"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-people" style="font-size: 3rem; color: #6c757d;"></i>
                            <h5 class="mt-3">Нет студентов</h5>
                            <p class="text-muted">У вас пока нет назначенных студентов</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Student Statistics -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">Всего студентов</h5>
                    <h3 class="text-primary">{{ students|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">Отличники</h5>
                    <h3 class="text-success">{{ students|selectattr('status', 'equalto', 'excellent')|list|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">В зоне риска</h5>
                    <h3 class="text-warning">{{ students|selectattr('status', 'equalto', 'at_risk')|list|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-graph-up text-info" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">Средний прогресс</h5>
                    <h3 class="text-info">{{ (students|map(attribute='overall_progress')|sum / students|length)|round(1) if students else 0 }}%</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function applyFilters() {
        const courseFilter = document.getElementById('courseFilter').value;
        const groupFilter = document.getElementById('groupFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        const rows = document.querySelectorAll('.student-row');
        
        rows.forEach(row => {
            let show = true;
            
            if (courseFilter && !row.dataset.course.includes(courseFilter)) {
                show = false;
            }
            
            if (groupFilter && row.dataset.group !== groupFilter) {
                show = false;
            }
            
            if (statusFilter && row.dataset.status !== statusFilter) {
                show = false;
            }
            
            if (searchInput && !row.dataset.name.includes(searchInput) && !row.dataset.id.includes(searchInput)) {
                show = false;
            }
            
            row.style.display = show ? 'table-row' : 'none';
        });
    }
    
    function viewStudent(studentId) {
        window.open(`/student/?student_id=${studentId}`, '_blank');
    }
    
    function viewProgress(studentId) {
        window.open(`/student/progress?student_id=${studentId}`, '_blank');
    }
    
    function sendMessage(studentId) {
        alert(`Функция отправки сообщения студенту ${studentId} будет реализована в следующих итерациях`);
    }
    
    function exportStudents() {
        alert('Функция экспорта студентов будет реализована в следующих итерациях');
    }
</script>
{% endblock %}